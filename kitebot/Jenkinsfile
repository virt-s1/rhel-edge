pipeline {
    agent none
    environment {
        TRIGGERED_BY = get_triggered_by()
    }

    stages {
        stage('Preparing') {
            when {
                beforeAgent true
                environment name: 'TRIGGERED_BY', value: 'Triggered by CI message.'
            }
            agent { label 'container-fedora-33-stage' }
            steps {
                script {
                    env.COMPOSE_ID = sh(returnStdout: true, script: 'echo $CI_MESSAGE | /usr/bin/jq -r ".compose_id"').trim()
                    currentBuild.displayName = "${env.BUILD_NUMBER}-${env.COMPOSE_ID}"
                    env.RELEASE_VERSION = sh(returnStdout: true, script: 'echo $CI_MESSAGE | /usr/bin/jq -r ".release_version"').trim()
                }
            }
        }
        stage('Testing') {
            parallel {
                stage('EL8.3 Virt') {
                    when {
                        beforeAgent true
                        anyOf {
                            anyOf {
                                environment name: 'TRIGGERED_BY', value: 'Branch indexing'
                                expression { return env.TRIGGERED_BY.matches("Pull request(.*)") }
                            }
                            allOf {
                                environment name: 'TRIGGERED_BY', value: 'Triggered by CI message.'
                                anyOf {
                                    environment name: 'RELEASE_VERSION', value: '8.3.0'
                                    environment name: 'RELEASE_VERSION', value: '8.3.1'
                                }
                            }
                        }
                    }
                    agent { label 'vm-rhel-8-3-1' }
                    environment {
                        TEST_OS = "rhel-8-3"
                    }
                    steps {
                        run_virt_test()
                    }
                    post {
                        always {
                            preserve_logs()
                        }
                    }
                }
                stage('EL8.3 Bare') {
                    when {
                        beforeAgent true
                        anyOf {
                            anyOf {
                                environment name: 'TRIGGERED_BY', value: 'Branch indexing'
                                expression { return env.TRIGGERED_BY.matches("Pull request(.*)") }
                            }
                            allOf {
                                environment name: 'TRIGGERED_BY', value: 'Triggered by CI message.'
                                anyOf {
                                    environment name: 'RELEASE_VERSION', value: '8.3.0'
                                    environment name: 'RELEASE_VERSION', value: '8.3.1'
                                }
                            }
                        }
                    }
                    agent { label 'container-fedora-33-stage' }
                    environment {
                        TEST_OS = "rhel-8-3"
                        ARCH = 'x86_64'
                    }
                    steps {
                        run_bare_test()
                    }
                    post {
                        always {
                            preserve_logs()
                        }
                    }
                }
                stage('EL8.4 Virt') {
                    when {
                        beforeAgent true
                        anyOf {
                            anyOf {
                                environment name: 'TRIGGERED_BY', value: 'Branch indexing'
                                expression { return env.TRIGGERED_BY.matches("Pull request(.*)") }
                            }
                            allOf {
                                environment name: 'TRIGGERED_BY', value: 'Triggered by CI message.'
                                anyOf {
                                    environment name: 'RELEASE_VERSION', value: '8.4.0'
                                    environment name: 'RELEASE_VERSION', value: '8.4.1'
                                }
                            }
                        }
                    }
                    agent { label 'vm-rhel-8-4-0' }
                    environment {
                        TEST_OS = "rhel-8-4"
                    }
                    steps {
                        run_virt_test()
                    }
                    post {
                        always {
                            preserve_logs()
                        }
                    }
                }
                stage('EL8.4 Bare') {
                    when {
                        beforeAgent true
                        anyOf {
                            anyOf {
                                environment name: 'TRIGGERED_BY', value: 'Branch indexing'
                                expression { return env.TRIGGERED_BY.matches("Pull request(.*)") }
                            }
                            allOf {
                                environment name: 'TRIGGERED_BY', value: 'Triggered by CI message.'
                                anyOf {
                                    environment name: 'RELEASE_VERSION', value: '8.4.0'
                                    environment name: 'RELEASE_VERSION', value: '8.4.1'
                                }
                            }
                        }
                    }
                    agent { label 'container-fedora-33-stage' }
                    environment {
                        TEST_OS = "rhel-8-4"
                        ARCH = 'x86_64'
                    }
                    steps {
                        run_bare_test()
                    }
                    post {
                        always {
                            preserve_logs()
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            script {
                print(currentBuild.getBuildCauses()[0])
            }
        }
    }
    options {
        timestamps()
        timeout(time: 2, unit: 'HOURS')
    }
}

void get_triggered_by() {
    return currentBuild.getBuildCauses()[0].shortDescription
}

void run_virt_test() {
    sh label: 'wait until cloud-init done', script: """
        while true; do
            test -f /var/lib/cloud/instance/boot-finished && break
        done
    """
    sh label: 'run ansible playbook', script: """
        printenv
        ./rhel-edge-virt-test.sh
    """
}

void run_bare_test() {
    withCredentials([string(credentialsId: 'ansible-vault-password', variable: 'VAULT_PASSWORD')]) {
        sh label: 'run ansible playbook', script: """
            printenv
            ansible-playbook -v -i inventory ostree-bare.yml
        """
    }
}

void preserve_logs() {
    archiveArtifacts allowEmptyArchive: true, artifacts: 'osbuild-*.log'
    archiveArtifacts allowEmptyArchive: true, artifacts: 'osbuild-*.json'
}
