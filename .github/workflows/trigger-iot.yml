name: Check Compose IDs
on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Runs hourly (adjust as needed)

env:
  COMPOSE_URL_44: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-44/COMPOSE_ID
  COMPOSE_URL_43: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-43/COMPOSE_ID
  COMPOSE_FILE_44: compose_id_44
  COMPOSE_FILE_43: compose_id_43

jobs:
  check-compose-44:
    runs-on: ubuntu-latest
    outputs:
      need-pr: ${{ steps.check-compose.outputs.need-pr }}
      compose-id: ${{ steps.get-compose-id.outputs.compose-id }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get compose ID for IoT 44
      id: get-compose-id
      run: |
        compose_id=$(curl -s $COMPOSE_URL_44)
        echo "compose-id=$compose_id" >> $GITHUB_OUTPUT
        echo "COMPOSE_ID=$compose_id" >> $GITHUB_ENV

    - name: Check if compose ID exists in file
      id: check-compose
      run: |
        if grep -q "$COMPOSE_ID" $COMPOSE_FILE_44; then
          echo "Compose ID exists in file"
          echo "need-pr=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check if PR already exists for this compose ID
        response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?state=open")
        if echo "$response" | grep -q "$COMPOSE_ID"; then
          echo "Open PR exists for this compose ID"
          echo "need-pr=false" >> $GITHUB_OUTPUT
        else
          echo "need-pr=true" >> $GITHUB_OUTPUT
        fi

  check-compose-43:
    runs-on: ubuntu-latest
    outputs:
      need-pr: ${{ steps.check-compose.outputs.need-pr }}
      compose-id: ${{ steps.get-compose-id.outputs.compose-id }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get compose ID for IoT 43
      id: get-compose-id
      run: |
        compose_id=$(curl -s $COMPOSE_URL_43)
        echo "compose-id=$compose_id" >> $GITHUB_OUTPUT
        echo "COMPOSE_ID=$compose_id" >> $GITHUB_ENV

    - name: Check if compose ID exists in file
      id: check-compose
      run: |
        if grep -q "$COMPOSE_ID" $COMPOSE_FILE_43; then
          echo "Compose ID exists in file"
          echo "need-pr=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check if PR already exists for this compose ID
        response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?state=open")
        if echo "$response" | grep -q "$COMPOSE_ID"; then
          echo "Open PR exists for this compose ID"
          echo "need-pr=false" >> $GITHUB_OUTPUT
        else
          echo "need-pr=true" >> $GITHUB_OUTPUT
        fi

  create-pr-44:
    runs-on: ubuntu-latest
    needs: check-compose-44
    if: needs.check-compose-44.outputs.need-pr == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update compose_id_44 file
      run: |
        echo "${{ needs.check-compose-44.outputs.compose-id }}" >> $COMPOSE_FILE_44

    - name: Create Pull Request for IoT 44
      id: create-pr
      uses: peter-evans/create-pull-request@v4
      with:
        title: "Update compose_id_44 with ${{ needs.check-compose-44.outputs.compose-id }}"
        branch: update-compose-44-${{ needs.check-compose-44.outputs.compose-id }}
        base: main
        body: "${{ needs.check-compose-44.outputs.compose-id }}"
        commit-message: "Add compose ID ${{ needs.check-compose-44.outputs.compose-id }} to compose_id_44"
        labels: |
          automated-pr
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Add test comment to PR
      if: steps.create-pr.outputs.pull-request-number
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
        body: "/test-iot"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-pr-43:
    runs-on: ubuntu-latest
    needs: check-compose-43
    if: needs.check-compose-43.outputs.need-pr == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update compose_id_43 file
      run: |
        echo "${{ needs.check-compose-43.outputs.compose-id }}" >> $COMPOSE_FILE_43

    - name: Create Pull Request for IoT 43
      id: create-pr
      uses: peter-evans/create-pull-request@v4
      with:
        title: "Update compose_id_43 with ${{ needs.check-compose-43.outputs.compose-id }}"
        branch: update-compose-43-${{ needs.check-compose-43.outputs.compose-id }}
        base: main
        body: "${{ needs.check-compose-43.outputs.compose-id }}"
        commit-message: "Add compose ID ${{ needs.check-compose-43.outputs.compose-id }} to compose_id_43"
        labels: |
          automated-pr
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Add test comment to PR
      if: steps.create-pr.outputs.pull-request-number
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
        body: "/test-iot"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
